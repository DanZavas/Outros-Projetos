---
title: "Regression Modeling Features from HBO Series Game of Thrones"
output: html_document
---

<style type="text/css">
body, td {
   font-size: 14px;
}
code.r{
  font-size: 16px;
}
pre {
  font-size: 16px
}
</style>

### **LOADING PACKAGES**

```{r setup, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
library(knitr)
library(dplyr)
library(ggpubr)
library(jtools)
library(ggplot2)
library(tidyverse)
library(caret)
library(readr)
library(MASS)
library(leaps)
library(lmtest)
library(car)
opts_chunk$set(echo = TRUE)
```

### **ENTERING THE DATA**

```{r data, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
my_data <- read_csv("GoT-characters (1).csv")
head(my_data)
```

### **DATA CLEANING**

```{r cleaning, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
extracted_data <- subset(my_data, select=c("exp_time_hrs", "dth_flag", "sex", "social_status", "allegiance_switched", "occupation", "prominence"))
## Removing "unknown" from Sex = NONE FOUND
levels(as.factor(extracted_data$sex))
## Removing "unknown" from Social Status = NONE FOUND
levels(as.factor(extracted_data$social_status))
## Removing "unknown" from Allegiance Switched = NONE FOUND
levels(as.factor(extracted_data$allegiance_switched))
## Removing "unknown" from Occupation = 49 FOUND
levels(as.factor(extracted_data$occupation))
table(extracted_data$occupation)
new_data <-subset(extracted_data, extracted_data$occupation != 9)
table(new_data$occupation)
```

### **SETTING REFERENCE GROUPS**

```{r set refs, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
# For dth flag
new_data$dth_flag <- factor(new_data$dth_flag)
levels(new_data$dth_flag)
new_data$dth_flag <- recode_factor(new_data$dth_flag, "0" = "2")
new_data$dth_flag <- C(new_data$dth_flag, contr.treatment, base=2)
levels(new_data$dth_flag)

## For Sex
new_data$sex <- factor(new_data$sex)
new_data$sex <- C(new_data$sex, contr.treatment, base=1)
levels(new_data$sex)

## For Social Status
new_data$social_status <- factor(new_data$social_status)
new_data$social_status <- C(new_data$social_status, contr.treatment, base=1)
levels(new_data$social_status)

## For Allegiance Switched

new_data$allegiance_switched <- factor(new_data$allegiance_switched)
new_data$allegiance_switched <- C(new_data$allegiance_switched, contr.treatment, base=1)
levels(new_data$allegiance_switched)

## For Occupation
new_data$occupation <- factor(new_data$occupation)
new_data$occupation <- C(new_data$occupation, contr.treatment, base=1)
levels(new_data$occupation)
```

## **RESOLUTIONS:**

### **QUESTION 1**: *(70 points) In this problem, the response is exp_time_hrs and the predictors are `dth_flag`, `sex`, `social_status`, `allegiance_switched`, `occupation`, and `prominence`.*

#### **Part A**: *(5 points) Draw a scatter plot of exp_time_hrs against prominence with different symbols/colors for different levels of dth_flag. Draw a second plot using the logarithm of prominence instead. Describe these two plots.*

```{r q1 part a, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
## First Plot
ggplot(new_data, aes(x=prominence, y=exp_time_hrs, shape=dth_flag, color=dth_flag)) + geom_point()+ geom_smooth(method=lm, se=FALSE, fullrange= TRUE, level=0.95, linetype="solid", fill="blue")+theme_classic()+labs(title="Survival Time by Prominence of Characters in GoT", x="Prominence", y = "Survival Time (in hours)")+theme(text = element_text(size=16))

## Second Plot
ggplot(new_data, aes(x=log(prominence), y=exp_time_hrs, shape=dth_flag, color=dth_flag)) + geom_point()+ geom_smooth(method=lm, se=FALSE, fullrange= TRUE, level=0.95, linetype="solid", fill="blue")+theme_classic()+labs(title="Survival Time by Prominence of Characters in GoT", x="Prominence", y = "Survival Time (in hours)")+theme(text = element_text(size=16))
```

<span style="color:red"> <font size="4"> **SOLUTION:** As observed, the prominence of a character has a positive, somewhat moderate relationship with his/her survival time in the series, that is, as much the character gets famous in the series, the more time they spend surviving. However, that seems to be a little different in whether the character dies or not. That is, if he/she dies the survival time rate is higher compared to those the do not die. Now, in terms of the log of the prominence, that relationship becomes quite scattered suggesting weak relationship between the variables. That is, 1 log unit change in prominence is attributed to a smaller survival rate among those that die compared to those who do not die </font> </span>

#### **Part B**: *(5 points) Fit a linear regression model with exp_time_hrs as the response and the predictors are dth_flag, sex, social_status, allegiance_switched, occupation, and the logarithm of prominence. For categorical variables, define dummy variables consistent with the reference levels specified above.*

```{r REG1, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
reg_1 <- lm(exp_time_hrs~dth_flag+sex+social_status+allegiance_switched+occupation+log(prominence), data=new_data)
summ(reg_1, digits = 4, confint = TRUE)
```

<span style="color:red"> <font size="4"> **SOLUTION:** As observed, the proposed linear model is $Survival Time = 15.6076+21.9378*(Dies)+3.0156*(Male)-8.7640*(Highborn)+12.3826*(No Switch)+5.1473*(Silk Collar)+5.5244*log(Prominence)$ </font> </span>

#### **Part C**: *(5 points) Interpret the effect of social status on the survival time of characters. Also construct the associated 95% confidence interval.*

<span style="color:red"> <font size="4"> **SOLUTION:** As observed from the output, the statistics for social status $β_{Social Status}$=-8.7640, t(1)=-3.50, p = 0.0005, 95% C.I. [-13.6936, -3.8343], suggest that average survival time difference between those characters who are highborn compared to lowborn is -8.7640, therefore, highborn are expected to survive about 8.7640 hours less than lowborn, and that estimation is free to vary between -3.8343 and -13.6936 hours.</font> </span>

#### **Part D**: *(5 points) What is the estimated survival time of a character who is not dead, male, lowborn, switched allegiance, silk collar and has prominence score 0.8?*

<span style="color:red"> <font size="4"> **SOLUTION:** Using the model from part A, we have the following: $Survival Time = 15.6076+21.9378*(2)+3.0156*(1)-8.7640*(1)+12.3826*(2)+5.1473*(1)+5.5244*log(0.8)$ and that results in a estimated survival time of 83.11 hours </font> </span>

#### **Part E**: *(5 points) Construct a 95% confidence interval for the mean response for such characters in the previous question.*

<span style="color:red"> <font size="4"> **SOLUTION:** UNKNOWN ERROR TO THE MODEL/CODE. NO ANSWER. </font> </span>

#### **Part F**: *(5 points) Complete the following ANOVA table corresponding to the fitted linear model.*

```{r anova reg1, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
anova(reg_1)
Source <- c("Model","Error", "Total")
df <- c(6,310)
`Sum Squares`<-c(53385,82211)
`Mean Squares`<-c(53385.40,265.2)
`F Value` <-c(201.30,"", "")
Total <- c(316,135596,53650.60)
aov_table <- as.data.frame(cbind(Source,df,`Sum Squares`,`Mean Squares`, `F Value`))
aov_table
```

#### **Part G**: *(5 points) Write out the null and alternative hypothesis corresponding to the above ANOVA table. What is the test statistic? What are the numbers of degrees of freedom? What is the p-value? What is your conclusion?*

```{r}
pf(201.30, 6, 310, lower.tail = FALSE)
```

<span style="color:red"> <font size="4"> **SOLUTION:** From the ANOVA table above, we have the following hypotheses: $H_0:β_{All Predictors}=0$ and $H_1:β_{At Least 1 Predictor}≠0$. From that hypothesis, the F test statistics associated to it was 201.30 and has a p value of < 0.0001, which indicate that the null hypothesis should be rejected since at least one of the variables is different from zero. </font> </span>

#### **Part H**: *(5 points) Draw the residual plot and QQ-plot. Comment on the model assumptions based on these two plots.*

```{r plot reg1,echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
plot(reg_1)
shapiro.test(reg_1$residuals)
bptest(reg_1)
```

<span style="color:red"> <font size="4"> **SOLUTION:** As observed from the graphs, the assumptions of normal and homogeneous residuals have been violated. That is, both tests presented p-value below 0.05 thus rejection of the hypothesis of normal residuals as well as homogeneous residuals. </font> </span>

#### **Part I**: *(5 points) What are the values of R-square and adjusted R-square for this model? Explain how these two quantities can be used.*

<span style="color:red"> <font size="4"> **SOLUTION:** As seen from the output, the value for R² is 0.3937 and for the Adj. R² the value is 0.3820. The R² refers to the overall explanation of the variance in survival time based on the variations in each predictor variable (39.37%). The Adj. R² value means the same, however, it adjusts the value based on the number of predictors that the model contains (38.20%). </font> </span>

#### **Part J**: *(5 points) Does the survival time of a character depend on whether he/she switched allegiance during the show after controlling the effect of the remaining covariates? Write out the null and alternative hypothesis. What is the test statistic? What is the number of degrees of freedom? What is the p-value? What is your conclusion?*

<span style="color:red"> <font size="4"> **SOLUTION:** As observed from the regression output, statistics of the variable "Allegiance Switched" are $β_{Allegiance Switched}$=12.3826, t(1)=4.5061, p = <0.0001, 95% C.I. [6.9756, 17.7895]. Therefore, since p-value is less than the significance level, the predictor is significant and one may infer that survival rate do depend on it. </font> </span>

#### **Part K**: *(5 points) One student fits a different linear regression model with two variables (sex and occupation) dropped. Compare this model with the model fitted in the previous questions. What one is better? Report test statistic, degrees of freedom, and p-value.*

```{r REG2, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
reg_2 <- lm(exp_time_hrs~dth_flag+social_status+allegiance_switched+log(prominence), data=new_data)
summ(reg_2, digits = 4, confint = TRUE)
anova(reg_2,reg_1)
```

<span style="color:red"> <font size="4"> **SOLUTION:** Applying the anova function to compare the models, we notice that reducing the model did not make any statistically significantly different than the model we already had, F = 2.9372, p = 0.05449. Also, in terms of R² or Adj. R² values we notice that this new model actually has lower R² and Adj. R² values compared to the first model. </font> </span>

#### **Part L**: *(5 points) Conduct variable selection using the stepwise selection procedure. What is the final model?*

```{r stepwise reg, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
step.model <- stepAIC(reg_1, direction = "both", 
                      trace = FALSE)
summ(step.model, digits=4)
```

<span style="color:red"> <font size="4"> **SOLUTION:** As observed, the final model is $Survival Time = 16.0362+22.287*(Dies)-8.3620*(Highborn)+12.7304*(No Switch)+4.7691*(Silk Collar)+5.4956*log(Prominence)$ </font> </span>

#### **Part M**: *(5 points) One student suggests that we should consider two-factor interactions. Based on the model selected using stepwise in the previous question, add all two-factor interactions among the variable selected. Report the result of the significance test for this model (test statistic, degrees of freedom, p-value, and conclusion).*

```{r REG3, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
reg_3 <- lm(exp_time_hrs~dth_flag*social_status*allegiance_switched*occupation*log(prominence), data=new_data)
summ(reg_3, digits = 4, confint = TRUE)
```

<span style="color:red"> <font size="4"> **SOLUTION:** As observed, the result of the significance test are: F(29,287) = 10.2803, p = 0.0000, R² = 0.5095, Adj. R² = 0.4599. In this terms, given the amount of variability explained by the model indicated by the F test statistic, the model is significant and could be used for predictions. </font> </span>

#### **Part N**: *(5 points) Based on the model in the previous question (main effect and two-factor interactions), conduct a variable selection using backward elimination. What is the final model?.*

```{r backward reg, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
back.model <- stepAIC(reg_3, direction = "backward", 
                      trace = FALSE)
summ(back.model, digits=4)
```

<span style="color:red"> <font size="4"> **SOLUTION:** As observed, the final model is $Survival Time = 20.0929+3.2944*(Dies)-10.9572*(Highborn)+1.6180*(No Switch)-3.0537*(Silk Collar)+10.9180*log(Prominence)+18.4145(Dies)*(Highborn)+8.2008(Dies)*(No Switch)+22.1323(Highborn)*(No Switch)+4.1167(Highborn)*(Silk Collar)+28.2693(No Switch)*(Silk Collar)-5.9947(Dies)*(log(Prominence))-0.1379(Highborn)*(log(Prominence))+10.1246(No Switch)*(log(Prominence))-16.1471(Silk Collar)*(log(Prominence))-46.0947(Highborn)*(No Switch)*(Silk Collar)+11.2383(Highborn)*(Silk Collar)*(log(Prominence))$ </font> </span>

### **QUESTION 2**: *(30 points) In this problem, the response is dth_flag and the predictors are sex, social_status, allegiance_switched, occupation, and the logarithm of prominence. Model the probability that a character died in the series.*

#### **Part A**: *(5 points) Fit a logistic regression model and write out the fitted regression function.*

```{r REG4, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
reg_4 <- glm(dth_flag~sex+social_status+allegiance_switched+occupation+log(prominence), family= "binomial", data=new_data)
summ(reg_4, digits = 4, confint = TRUE)
```

<span style="color:red"> <font size="4"> **SOLUTION:** As observed, the final model is $p = 1 / (1+exp(-(1.3196-0.6185(Male)+0.0124(Highborn)-1.3424(No Switch)-0.0254(Silk Collar)+1.1862(log(Prominence)))))$ </font> </span>

#### **Part B**: *(5 points) Interpret the effect of switching allegiance in terms of odds ratio.*

```{r}
exp(coef(reg_4))
```

<span style="color:red"> <font size="4"> **SOLUTION:** The odds ratio for Allegiance Switch is 0.2612, which means that the odds of surviving of a character who is switched of allegiances is 0.2612 times higher than those who are not switched. </font> </span>

#### **Part C**: *(5 points) Does the probability that a character died in the series depend on these variables? In another word, is this model significant? Report test statistic, degrees of freedom, p-value, and your conclusion.*

<span style="color:red"> <font size="4"> **SOLUTION:** As observed, statistics of the model: χ²(5) = 74.4282, p = 0.0000, Pseudo-R² (Cragg-Uhler) = 0.2855, AIC = 356.0987, BIC = 378.6521, suggest the model is significant since the p-value is smaller than the significance level. </font> </span>

#### **Part D**: *(5 points) Does the probability that a character died in the series depend on his/her social status after controlling the effect of the remaining covariate? Report test statistic, p-value, and your conclusion.*

<span style="color:red"> <font size="4"> **SOLUTION:** As observed from the statistics of the predictor:$β_{Social Status}$=0.0124, z = 0.0345, p = 0.9725, 95% C.I. [-0.6926, 0.7174], no, it does not, given that the p-value is smaller than the significance level. </font> </span>

#### **Part E**: *(5 points) What is the estimated probability that a character will die if this character is male, lowborn, switched allegiance, silk collar and has prominence score 0.8?*

<span style="color:red"> <font size="4"> **SOLUTION:** As observed from the model, the probability will be: $p = 1 / (1+exp(-(1.3196-0.6185(1)+0.0124(2)-1.3424(2)-0.0254(1)+1.1862(log(0.8)))))$ is 0.1091 thus 10.91% chance. </font> </span>

#### **Part F**: *(5 points) One student fits a similar model with only two variables (allegiance_switched and the logarithm of prominence). Compare this model with the model fitted in the previous question. Which one is better? Report test statistic, degrees of freedom, p-value, and your conclusion.*

```{r REG5, echo=TRUE, include=TRUE, warning=FALSE,message=FALSE}
reg_5 <- glm(dth_flag~allegiance_switched+log(prominence), family= "binomial", data=new_data)
summ(reg_5, digits = 4, confint = TRUE)
anova(reg_5, reg_4)
```

<span style="color:red"> <font size="4"> **SOLUTION:** Applying the anova function to compare the models, we notice that reducing the model did not make any statistically significantly different than the model we already had, Deviance = 3.7023. Also, in terms of R² or Adj. R² values we notice that this new model has almost the same R² and Adj. R² values compared to the first model. </font> </span>
